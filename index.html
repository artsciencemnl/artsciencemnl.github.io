// Drawer
const drawer = document.getElementById('drawer');
const openBtn = document.getElementById('openDrawer');
const closeBtn = drawer.querySelector('.close');

function openDrawer(){ drawer.classList.add('open'); document.body.style.overflow='hidden'; }
function closeDrawer(){ drawer.classList.remove('open'); document.body.style.overflow=''; }

openBtn.addEventListener('click', openDrawer);
closeBtn.addEventListener('click', closeDrawer);
drawer.addEventListener('click', (e) => {
  // close when clicking outside inner pane area
  if(e.target === drawer) closeDrawer();
});

// Search overlay
const searchOverlay = document.getElementById('searchOverlay');
const openSearch = document.getElementById('openSearch');
const openSearchFromHeader = document.getElementById('openSearchFromHeader');
const closeSearch = document.getElementById('closeSearch');
const q = document.getElementById('q');
const results = document.getElementById('results');

function showSearch(){
  searchOverlay.classList.add('open');
  q.value = '';
  results.innerHTML = '';
  setTimeout(()=> q.focus(), 50);
}
function hideSearch(){
  searchOverlay.classList.remove('open');
}

openSearch?.addEventListener('click', showSearch);
openSearchFromHeader?.addEventListener('click', showSearch);
closeSearch?.addEventListener('click', hideSearch);
searchOverlay.addEventListener('click', (e)=>{ if(e.target === searchOverlay) hideSearch(); });

// Tiny on-page search (matches data-search paragraphs and headings)
const searchable = Array.from(document.querySelectorAll('[data-search], .text h1, .text h2'));

q?.addEventListener('input', () => {
  const term = q.value.trim().toLowerCase();
  results.innerHTML = '';
  if(!term){ return; }
  let count = 0;
  searchable.forEach(el => {
    const txt = el.textContent.toLowerCase();
    if(txt.includes(term)){
      count++;
      const id = el.closest('section')?.id || 'top';
      const preview = el.textContent.trim().slice(0, 140);
      const div = document.createElement('div');
      div.className = 'hit';
      div.innerHTML = `<a href="#${id}" onclick="document.getElementById('closeSearch').click()">${preview}</a>`;
      results.appendChild(div);
    }
  });
  if(count === 0){
    const div = document.createElement('div');
    div.className='hit';
    div.textContent = 'No matches found.';
    results.appendChild(div);
  }
});
